version: "3.8"

services:
  postgres-primary:
    image: postgres:14
    command: ["postgres", "-p", "5432", "-c", "shared_preload_libraries=pg_stat_statements", "-c", "pg_stat_statements.track=all", "-c", "pg_stat_statements.max=100000"]
    environment:
      POSTGRES_USER: postgres
      POSTGRES_DB: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_INITDB_ARGS: --auth-local=md5 --auth-host=md5 --auth=md5
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -p 5432"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      pgcat-network:
        aliases:
          - postgres-primary

  postgres-scram-1:
    image: postgres:14
    command: ["postgres", "-p", "5432", "-c", "shared_preload_libraries=pg_stat_statements", "-c", "pg_stat_statements.track=all", "-c", "pg_stat_statements.max=100000"]
    environment:
      POSTGRES_USER: postgres
      POSTGRES_DB: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_INITDB_ARGS: --auth-local=scram-sha-256 --auth-host=scram-sha-256 --auth=scram-sha-256
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -p 5432"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      pgcat-network:
        aliases:
          - postgres-scram-1

  postgres-scram-2:
    image: postgres:14
    command: ["postgres", "-p", "5432", "-c", "shared_preload_libraries=pg_stat_statements", "-c", "pg_stat_statements.track=all", "-c", "pg_stat_statements.max=100000"]
    environment:
      POSTGRES_USER: postgres
      POSTGRES_DB: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_INITDB_ARGS: --auth-local=scram-sha-256 --auth-host=scram-sha-256 --auth=scram-sha-256
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -p 5432"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      pgcat-network:
        aliases:
          - postgres-scram-2

  postgres-scram-3:
    image: postgres:14
    command: ["postgres", "-p", "5432", "-c", "shared_preload_libraries=pg_stat_statements", "-c", "pg_stat_statements.track=all", "-c", "pg_stat_statements.max=100000"]
    environment:
      POSTGRES_USER: postgres
      POSTGRES_DB: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_INITDB_ARGS: --auth-local=scram-sha-256 --auth-host=scram-sha-256 --auth=scram-sha-256
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -p 5432"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      pgcat-network:
        aliases:
          - postgres-scram-3

  postgres-md5:
    image: postgres:14
    command: ["postgres", "-p", "5432", "-c", "shared_preload_libraries=pg_stat_statements"]
    environment:
      POSTGRES_USER: postgres
      POSTGRES_DB: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_INITDB_ARGS: --auth-local=md5 --auth-host=md5 --auth=md5
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -p 5432"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      pgcat-network:
        aliases:
          - postgres-md5

  ci:
    image: ghcr.io/postgresml/pgcat-ci:latest
    working_dir: /app
    volumes:
      - .:/app
    environment:
      RUST_LOG: info
    depends_on:
      postgres-primary:
        condition: service_healthy
      postgres-scram-1:
        condition: service_healthy
      postgres-scram-2:
        condition: service_healthy
      postgres-scram-3:
        condition: service_healthy
      postgres-md5:
        condition: service_healthy
    networks:
      - pgcat-network
    command: ["sleep", "infinity"]

networks:
  pgcat-network:
    driver: bridge
